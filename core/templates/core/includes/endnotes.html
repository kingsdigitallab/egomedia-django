{% load wagtailcore_tags %}

{% if page.endnotes %}

{% with endnotes=page.endnotes.all|dictsort:"sort_order" %}
<div class="block endnotes">
  <a class="anchor-link" id="endnotes"></a>
  <h2>Endnotes</h2>

  <ol>
    {% for endnote in endnotes %}
    <li id="fn:{{ forloop.counter }}">
      {% if endnote.pre_text %}
      <div class="join">
        {{ endnote.pre_text|richtext }}
      </div>
      {% endif %}

      {% if endnote.bibliography_shortnote %}
      <div class="join">
        {{ endnote.bibliography_entry.shortnote }}
      </div>
      {% else %}
      <div class="join">
        {{ endnote.bibliography_entry.note }}
      </div>
      {% endif %}

      {% if endnote.bibliography_pages %}
      <div class="join">{{ endnote.bibliography_pages }}.</div>
      {% endif %}

      {% if endnote.post_text %}
      <div class="join">
        {{ endnote.post_text|richtext }}
      </div>
      {% endif %}
    </li>
    {% endfor %}
  </ol>
</div>
{% endwith %}

<div class="block bibliography">
  <a class="anchor-link" id="bibliography"></a>
  <h2>Bibliography</h2>

  <ul class="no-bullet">
    {% regroup page.get_endnotes_by_entry by bibliography_entry as entry_list %}

    {% for entry in entry_list %}
    <li>{{ entry.grouper.entry }}</li>
    {% endfor %}
  </ul>
</div>

{% endif %}
